package me.gamrboy4life.paradox.command.commands;

import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.nio.file.Paths;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;

import me.gamrboy4life.paradox.command.Command;
import net.minecraft.client.Minecraft;
import net.minecraft.network.play.client.C01PacketChatMessage;

public class Tran extends Command {

    private static final String GO_TRAN_DIR = "C:\\Users\\yztim\\myproject\\go-tran\\cmd\\tran";
    private final ExecutorService executorService = Executors.newSingleThreadExecutor();

    public Tran() {
        super("tran", "Tranでja->en", "tran", "t");
    }

    @Override
    public void onCommand(String[] args, String command) {
        if (args.length == 0) {
            Minecraft.getMinecraft().thePlayer.sendQueue.addToSendQueue(new C01PacketChatMessage("Usage: /tran <text>"));
            return;
        }

        final String textToTranslate = String.join(" ", args);

        // 別スレッドで翻訳処理を実行
        executorService.submit(new Runnable() {
            @Override
            public void run() {
                String translatedText = translateText(textToTranslate);
                if (translatedText != null) {
                    // メインスレッドでチャットにメッセージを送信
                    Minecraft.getMinecraft().thePlayer.sendQueue.addToSendQueue(new C01PacketChatMessage(translatedText));
                } else {
                    Minecraft.getMinecraft().thePlayer.sendQueue.addToSendQueue(new C01PacketChatMessage("Translation failed."));
                }
            }
        });
    }

    private String translateText(String text) {
        try {
            // GO-TRANのプロセスを開始
            ProcessBuilder processBuilder = new ProcessBuilder("go", "run", "main.go");
            processBuilder.directory(Paths.get(GO_TRAN_DIR).toFile());  // カレントディレクトリを設定
            processBuilder.redirectErrorStream(true);
            Process process = processBuilder.start();

            // 標準入力にコマンドを送信
            OutputStream outputStream = process.getOutputStream();
            
            // "en" コマンドで英語モードに切り替え
            outputStream.write("en\n".getBytes());
            outputStream.flush();
            
            // 少し待つ
            Thread.sleep(500);  // 0.5秒待機

            // 翻訳するテキストを送信
            outputStream.write((text + "\n").getBytes());
            outputStream.flush();
            outputStream.close();

            // 標準出力から翻訳結果を読み取る
            InputStream inputStream = process.getInputStream();
            BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream));
            StringBuilder output = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                output.append(line).append("\n");
            }
            process.waitFor(10, TimeUnit.SECONDS);  // プロセスの完了を待機

            return output.toString().trim();
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }
}